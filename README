# newt bash builtin

A [bash loadable builtin](https://www.gnu.org/software/bash/manual/html_node/bash_builtin.html) that exposes the [newt](https://pagure.io/newt) TUI library directly to shell scripts.  Instead of shelling out to a helper program, you load `newt.so` once with `enable -f` and then call `newt Init`, `newt OpenWindow`, `newt Button`, etc. as ordinary bash commands.


---

## Requirements

| Dependency | Notes |
|---|---|
| **bash** headers | Usually in `/usr/include/bash`; package: `bash-devel` / `bash-dev` |
| **libnewt** + headers | Package: `newt-devel` / `libnewt-dev` |
| **CMake** ≥ 3.14 | For FetchContent (Catch2) |
| C++17 compiler | gcc or clang |

Install on Debian/Ubuntu:
```bash
sudo apt install bash-builtins libnewt-dev cmake g++
```

Install on Fedora/RHEL:
```bash
sudo dnf install bash-devel newt-devel cmake gcc-c++
```

---

## Build

```bash
cmake -B build
cmake --build build
```

The shared library is produced at `build/src/newt.so`.

If your bash headers are in a non-standard location pass `-DBASH_HEADERS=/path/to/prefix`:
```bash
cmake -B build -DBASH_HEADERS=/usr/local
cmake --build build
```

To install `newt.so` to `lib/bash` (so bash picks it up via `BASH_LOADABLES_PATH`):
```bash
cmake --install build
```

---

## Usage

```bash
enable -f build/src/newt.so newt   # load the builtin

if newt Init; then
    trap 'newt Finished' EXIT
    newt Cls
    newt OpenWindow 10 5 40 7 "Hello"
    newt -v lbl Label 10 1 "Hello, world!"
    newt -v frm Form '' '' 0
    newt FormAddComponent "$frm" "$lbl"
    newt RunForm "$frm"
    newt FormDestroy "$frm"
fi
```

The `examples/` directory contains more examples covering windows, labels,
entries, forms, buttons and callbacks.

---

## Null pointers — `""` in, `"(nil)"` out

Pointer arguments (`newtComponent`, `newtGrid`) use an **empty string** to
represent a null pointer on input.  The C string `"NULL"` is **not
accepted** and will cause a parse error.

```bash
# Correct — empty string means nullptr:
newt -v f Form '' '' 0

# WRONG — will fail with a usage error:
newt -v f Form NULL '' 0
```

When the builtin *returns* a null pointer (e.g. `newtRunForm` after the user
presses ESC), the value bound to the variable is `"(nil)"` — the string
produced by glibc's `printf("%p", NULL)`.

```bash
newt -v result RunForm "$f"
if [[ "$result" == "(nil)" ]]; then
    echo "User pressed ESC"
fi
```

| Direction | Null representation | Example |
|-----------|--------------------|---------|
| **Input** (bash → builtin)  | `""` (empty string) | `newt -v f Form '' '' 0` |
| **Output** (builtin → bash) | `"(nil)"` | `[[ "$var" == "(nil)" ]]` |

> **Why not `"NULL"`?**  The builtin parses pointer strings with
> `sscanf("%p")`.  On Linux/glibc, `sscanf("NULL", "%p")` returns 0
> (no match), so `"NULL"` fails parsing.  The empty string is handled as a
> special case before `sscanf` is tried.

---

## Running the tests

### Unit tests (C++ / Catch2)

These tests cover argument parsing and type conversion with no display needed —
Catch2 is fetched automatically by CMake.

```bash
cmake -B build
cmake --build build
ctest --test-dir build --output-on-failure
```

### Functional tests (Python / pytest)

Functional tests spawn a real `bash` process inside a pty ([pexpect](https://pexpect.readthedocs.io/)) and assert on the *rendered* terminal screen ([pyte](https://pyte.readthedocs.io/)).  Requires [uv](https://docs.astral.sh/uv/getting-started/installation/).

```bash
# Build the shared library first (see above).

cd functional_test
uv sync              # one-time: creates .venv and installs dependencies
uv run pytest -v
```

See [functional_test/README.md](functional_test/README.md) for full details.

---

## License

This project is licensed under the same terms as `libnewt` — the [GNU Library General Public License v2.0 (LGPL-2.0)](LICENSE).

Newt library homepage: https://pagure.io/newt
